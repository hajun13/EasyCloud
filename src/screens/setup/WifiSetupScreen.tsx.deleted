import React, { useState, useContext, useEffect, useCallback } from 'react';
import { 
  View, 
  Text, 
  StyleSheet, 
  ScrollView,
  KeyboardAvoidingView,
  Platform,
  Alert,
  ActivityIndicator,
  TouchableOpacity,
  RefreshControl,
  Modal
} from 'react-native';
import { useNavigation, NavigationProp } from '@react-navigation/native';
import Input from '../../components/common/Input';
import LoadingSpinner from '../../components/common/LoadingSpinner';
import Header from '../../components/common/Header';
import { DeviceContext } from '../../contexts/DeviceContext';
import Colors from '../../constants/colors';
import AsyncStorage from '@react-native-async-storage/async-storage';
import deviceService from '../../services/deviceService';
import Ionicons from '@expo/vector-icons/Ionicons';
import { saveDeviceURL } from '../../utils/apiClient';
import { storeData } from '../../utils/storage';

// 16ì§„ìˆ˜ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ë¥¼ ì‹¤ì œ ë¬¸ìë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
const decodeHexEscapeSequence = (str: string): string => {
  if (!str) return '';
  
  // ì¼ë°˜ì ì¸ URL ë””ì½”ë”© ì‹œë„
  let decodedStr = str;
  try {
    if (decodedStr.includes('%')) {
      decodedStr = decodeURIComponent(decodedStr);
    }
  } catch (e) {
    console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', e);
  }
  
  // \x ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ì²˜ë¦¬
  try {
    if (decodedStr.includes('\\x')) {
      // \x ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ë¥¼ ì‹¤ì œ ë°”ì´íŠ¸ë¡œ ë³€í™˜
      const hexStr = decodedStr.replace(/\\x([0-9A-Fa-f]{2})/g, (_, hex) => {
        return String.fromCharCode(parseInt(hex, 16));
      });
      
      // UTF-8 ë°”ì´íŠ¸ ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ ì‹œë„
      try {
        // TextEncoder/TextDecoder APIê°€ ìˆëŠ”ì§€ í™•ì¸
        if (typeof TextDecoder !== 'undefined') {
          const bytes = new Uint8Array(hexStr.length);
          for (let i = 0; i < hexStr.length; i++) {
            bytes[i] = hexStr.charCodeAt(i);
          }
          const decoder = new TextDecoder('utf-8');
          return decoder.decode(bytes);
        } else {
          // ë ˆê±°ì‹œ ì§€ì›
          return hexStr;
        }
      } catch (e) {
        console.warn('UTF-8 ë””ì½”ë”© ì‹¤íŒ¨:', e);
        return hexStr;
      }
    }
  } catch (e) {
    console.warn('ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ë””ì½”ë”© ì‹¤íŒ¨:', e);
  }
  
  return decodedStr;
};


// WiFi ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤
interface WifiNetwork {
  ssid: string;
  ssid_raw?: string; // ì›ë³¸ SSID í˜•ì‹ (ì¸ì½”ë”©ì„ ìœ„í•´ ì¶”ê°€)
  signal_strength: number | null;
  security: string;
  channel: number | null;
  mac_address: string | null;
  connected?: boolean; // í˜„ì¬ ì—°ê²°ëœ ë„¤íŠ¸ì›Œí¬ì¸ì§€ ì—¬ë¶€
}

// ê¸°ê¸° ì •ë³´ íƒ€ì… ì •ì˜
interface DeviceInfo {
  device_id: string;
  local_ip: string;
  [key: string]: any; // ì¶”ê°€ ì†ì„±ì´ ìˆì„ ìˆ˜ ìˆìŒ
}

// ì»¨í…ìŠ¤íŠ¸ íƒ€ì… ì •ì˜
interface DeviceContextType {
  setupWifi: (ssid: string, password: string) => Promise<boolean>;
  deviceInfo: DeviceInfo | null;
  loading: boolean;
  refreshDeviceStatus: () => Promise<void>;
}

// ì—ëŸ¬ ìƒíƒœ íƒ€ì… ì •ì˜
interface FormErrors {
  ssid: string;
  password: string;
}

// ë„¤ë¹„ê²Œì´ì…˜ íƒ€ì… ì •ì˜
type RootStackParamList = {
  HomeTab: undefined;
  // ë‹¤ë¥¸ ë¼ìš°íŠ¸ ì¶”ê°€ ê°€ëŠ¥
};

const WifiSetupScreen = () => {
  const navigation = useNavigation<NavigationProp<RootStackParamList>>();
  const { setupWifi, deviceInfo, loading, refreshDeviceStatus, connectDevice  } = useContext(DeviceContext) as DeviceContextType;
  
  const [ssid, setSsid] = useState('');
  const [password, setPassword] = useState('');
  const [errors, setErrors] = useState<FormErrors>({ ssid: '', password: '' });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isTestingConnection, setIsTestingConnection] = useState(false);
  const [localDeviceInfo, setLocalDeviceInfo] = useState<DeviceInfo | null>(null);
  
  // WiFi ìŠ¤ìº” ê´€ë ¨ ìƒíƒœ
  const [networks, setNetworks] = useState<WifiNetwork[]>([]);
  const [isScanning, setIsScanning] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [showNetworkList, setShowNetworkList] = useState(false);
  
  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
  useEffect(() => {
    console.log('ğŸ” WifiSetupScreen ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ë¨');
    console.log('ğŸ“± deviceInfo:', deviceInfo);
    console.log('ğŸ”„ loading ìƒíƒœ:', loading);
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ QR ë°ì´í„° í™•ì¸ (ì›¹/ë„¤ì´í‹°ë¸Œ í™˜ê²½ ëª¨ë‘ ëŒ€ì‘)
    const getStoredDeviceInfo = async () => {
      try {
        let storedDeviceInfo = null;
        
        if (Platform.OS === 'web' && typeof window !== 'undefined' && window.localStorage) {
          // ì›¹ í™˜ê²½
          storedDeviceInfo = localStorage.getItem('deviceInfo');
          console.log('ğŸ’¾ ì›¹ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ deviceInfo:', storedDeviceInfo);
        } else {
          // ë„¤ì´í‹°ë¸Œ í™˜ê²½
          storedDeviceInfo = await AsyncStorage.getItem('deviceInfo');
          console.log('ğŸ’¾ AsyncStorage deviceInfo:', storedDeviceInfo);
        }
        
        // ê¸°ê¸° ì •ë³´ê°€ ì»¨í…ìŠ¤íŠ¸ì— ì—†ì§€ë§Œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìˆìœ¼ë©´ ì‚¬ìš©
        if (!deviceInfo && storedDeviceInfo) {
          try {
            const parsedDeviceInfo = JSON.parse(storedDeviceInfo);
            console.log('ğŸ“‹ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µì›í•œ ê¸°ê¸° ì •ë³´:', parsedDeviceInfo);
            setLocalDeviceInfo(parsedDeviceInfo);
          } catch (error) {
            console.error('âŒ ê¸°ê¸° ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', error);
          }
        }
      } catch (error) {
        console.error('âŒ ì €ì¥ì†Œ ì ‘ê·¼ ì˜¤ë¥˜:', error);
      }
    };
    
    getStoredDeviceInfo();
    
    // í™”ë©´ì´ ë§ˆìš´íŠ¸ë  ë•Œ ìë™ìœ¼ë¡œ WiFi ìŠ¤ìº” ì‹œì‘
    scanWifiNetworks();
    
    return () => {
      console.log('ğŸ” WifiSetupScreen ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ë¨');
    };
  }, [deviceInfo, loading]);
  
  // WiFi ìŠ¤ìº” í•¨ìˆ˜ - ë””ë²„ê¹… ë° í•œê¸€ ì²˜ë¦¬ ê°œì„ 
  const scanWifiNetworks = useCallback(async () => {
    console.log('ğŸ“¡ WiFi ë„¤íŠ¸ì›Œí¬ ìŠ¤ìº” ì‹œì‘');
    setIsScanning(true);
    
    try {
      const result = await deviceService.scanWifiNetworks();
      
      if (result.success && result.networks) {
        console.log('âœ… WiFi ìŠ¤ìº” ì„±ê³µ:', result.networks.length, 'ê°œì˜ ë„¤íŠ¸ì›Œí¬ ë°œê²¬');
        console.log('ì „ì²´ ë„¤íŠ¸ì›Œí¬ ë°›ì€ ë°ì´í„°:', result.networks);
        
        // í•œê¸€ SSID ê°€ ìˆëŠ”ì§€ í™•ì¸
        const hasKoreanSSID = result.networks.some(network => {
          // URL ì¸ì½”ë”©ëœ í•œê¸€ì´ ìˆëŠ”ì§€ ì²´í¬
          return network.ssid && network.ssid.includes('%E');
        });
        
        console.log('í•œê¸€ SSID í¬í•¨ í™•ì¸:', hasKoreanSSID);
        
        // í•œê¸€ SSID ì›ë³¸ê³¼ ì¸ì½”ë”©ëœ ê°’ ì¶œë ¥
        result.networks.forEach((network, idx) => {
          if (network.ssid && network.ssid.includes('%')) {
            try {
              const decoded = decodeURIComponent(network.ssid);
              console.log(`ë„¤íŠ¸ì›Œí¬ ${idx+1} ë””ì½”ë”©:`, {
                original: network.ssid,
                decoded: decoded,
                raw: network.ssid_raw
              });
            } catch (e) {
              console.warn(`ë„¤íŠ¸ì›Œí¬ ${idx+1} ë””ì½”ë”© ì˜¤ë¥˜:`, e);
            }
          }
        });
        
        setNetworks(result.networks);
        setShowNetworkList(true);
      } else {
        console.error('âŒ WiFi ìŠ¤ìº” ì‹¤íŒ¨:', result.message);
        // ì›¹ í™˜ê²½ê³¼ ë„¤ì´í‹°ë¸Œ í™˜ê²½ì— ë§ëŠ” ì•Œë¦¼ í‘œì‹œ
        if (Platform.OS === 'web') {
          window.alert(`WiFi ìŠ¤ìº” ì‹¤íŒ¨: ${result.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'}`);
        } else {
          Alert.alert(
            'WiFi ìŠ¤ìº” ì‹¤íŒ¨',
            result.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
            [{ text: 'í™•ì¸' }]
          );
        }
      }
    } catch (error) {
      console.error('âŒ WiFi ìŠ¤ìº” ì˜¤ë¥˜:', error);
    } finally {
      setIsScanning(false);
      setRefreshing(false);
    }
  }, []);
  
  // ìƒˆë¡œê³ ì¹¨ ì²˜ë¦¬
  const handleRefresh = useCallback(() => {
    setRefreshing(true);
    scanWifiNetworks();
  }, [scanWifiNetworks]);
  
  // WiFi ì„ íƒ ì²˜ë¦¬ - í•œê¸€ ì¸ì½”ë”© ë¬¸ì œ ì²˜ë¦¬ ê°œì„ 
  const handleSelectNetwork = useCallback((network: WifiNetwork) => {
    // ë””ì½”ë”© ì‹œë„ (SSIDê°€ í•œê¸€ì´ë‚˜ ì¸ì½”ë”©ëœ ë¬¸ìì¸ ê²½ìš°)
    let decodedSsid = network.ssid;
    console.log('ğŸ”˜ ì„ íƒëœ ì›ë³¸ WiFi SSID:', network.ssid);
    
    // 1. URL ì¸ì½”ë”©ëœ ê²½ìš° ë””ì½”ë”©
    try {
      if (network.ssid && network.ssid.includes('%')) {
        decodedSsid = decodeURIComponent(network.ssid);
        console.log('URL ë””ì½”ë”©ëœ SSID:', decodedSsid);
      }
    } catch (e) {
      console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', e);
    }
    
    // 2. ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤(\x) ì²˜ë¦¬
    try {
      // ì›ë³¸ SSID ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ì²˜ë¦¬ 
      if (network.ssid_raw && network.ssid_raw.includes('\\x')) {
        const properSsid = decodeHexEscapeSequence(network.ssid_raw);
        console.log('16ì§„ìˆ˜ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ë””ì½”ë”©:', properSsid);
        decodedSsid = properSsid; // ë” ì •í™•í•œ ê²°ê³¼ ì‚¬ìš©
      }
      // ë””ì½”ë”©ëœ SSIDì—ë„ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ê°€ ìˆëŠ” ê²½ìš°
      else if (decodedSsid && decodedSsid.includes('\\x')) {
        decodedSsid = decodeHexEscapeSequence(decodedSsid);
        console.log('ë””ì½”ë”©ëœ SSIDì˜ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ì²˜ë¦¬:', decodedSsid);
      }
    } catch (e) {
      console.warn('ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ë””ì½”ë”© ì‹¤íŒ¨:', e);
    }
    
    console.log('ìµœì¢… ì‚¬ìš©í•  í•œê¸€ SSID:', decodedSsid);
    
    // SSID ì„¤ì •
    setSsid(decodedSsid);
    setShowNetworkList(false);
    
    // ë³´ì•ˆ ë°©ì‹ì´ OPENì¸ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ í•„ìš” ì—†ìŒ
    if (network.security === 'OPEN') {
      setPassword('');
    }
  }, []);
  
  // ì‹ í˜¸ ê°•ë„ ë°” ì•„ì´ì½˜ ê²°ì •
  const getSignalIcon = (strength: number | null) => {
    if (strength === null) return 'wifi-outline';
    
    // dBm ê°’ì„ ë°±ë¶„ìœ¨ë¡œ ë³€í™˜ (ì¼ë°˜ì ìœ¼ë¡œ -50dBmì€ 100%, -100dBmì€ 0%ë¡œ ê°„ì£¼)
    const percentage = Math.max(0, Math.min(100, ((strength + 100) * 2)));
    
    if (percentage >= 70) return 'wifi';
    if (percentage >= 40) return 'wifi-outline';
    return 'wifi-outline';
  };
  
  // ë³´ì•ˆ íƒ€ì… ì•„ì´ì½˜ ê²°ì •
  const getSecurityIcon = (security: string) => {
    switch (security) {
      case 'WPA2':
      case 'WPA':
        return 'lock-closed';
      case 'WEP':
        return 'lock-open';
      case 'OPEN':
        return 'globe';
      default:
        return 'help-circle';
    }
  };
  
  const validateForm = (): boolean => {
    console.log('ğŸ” í¼ ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘');
    let isValid = true;
    const newErrors = { ssid: '', password: '' };
    
    if (!ssid) {
      newErrors.ssid = 'WiFi ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
      isValid = false;
    }
    
    // ë¹„ë°€ë²ˆí˜¸ëŠ” ì„ íƒì ìœ¼ë¡œ í—ˆìš© (ì˜¤í”ˆ ë„¤íŠ¸ì›Œí¬ ì§€ì›)
    
    setErrors(newErrors);
    console.log('ğŸ” í¼ ìœ íš¨ì„± ê²€ì‚¬ ê²°ê³¼:', isValid);
    return isValid;
  };
  
  const handleSetupWifi = async () => {
    console.log('ğŸ”˜ WiFi ì„¤ì • ë²„íŠ¼ í´ë¦­ë¨');
  
    if (!validateForm()) {
      console.log('âŒ í¼ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨');
      return;
    }
  
    console.log('âœ… í¼ ìœ íš¨ì„± ê²€ì‚¬ ì„±ê³µ');
    setIsSubmitting(true);
  
    try {
      console.log('ğŸ”„ setupWifi í˜¸ì¶œ ì‹œì‘:', { ssid, password: '********' });
      const response = await deviceService.setupWifi({ ssid, password });
      console.log('ğŸ”„ WiFi ì„¤ì • ì‘ë‹µ:', response);
  
      if (response && response.success) {
        setIsTestingConnection(true);
  
        Alert.alert(
          'WiFi ì„¤ì • ì™„ë£Œ',
          'ê¸°ê¸°ê°€ ìƒˆë¡œìš´ WiFi ë„¤íŠ¸ì›Œí¬ì— ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ê¸°ê¸° ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.',
          [{ text: 'í™•ì¸' }]
        );
  
        console.log('â±ï¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì‹œì‘');
        await new Promise(resolve => setTimeout(resolve, 10000));
        console.log('â±ï¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì™„ë£Œ');
  
        try {
          let newDeviceInfo = null;
          let attempts = 0;
          const maxAttempts = 3;
  
          while (attempts < maxAttempts) {
            try {
              console.log(`ğŸ”„ ìƒˆ IP ì£¼ì†Œ í™•ì¸ ì‹œë„ ${attempts + 1}/${maxAttempts}`);
              newDeviceInfo = await deviceService.getDeviceInfo();
  
              if (newDeviceInfo && newDeviceInfo.local_ip) {
                console.log('âœ… ìƒˆ IP ì£¼ì†Œ í™•ì¸ ì„±ê³µ:', newDeviceInfo.local_ip);
                break;
              }
            } catch (error) {
              console.log(`âš ï¸ ì‹œë„ ${attempts + 1} ì‹¤íŒ¨:`, error);
            }
  
            attempts++;
            if (attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 5000));
            }
          }
  
          if (newDeviceInfo && newDeviceInfo.local_ip) {
            const newBaseUrl = `http://${newDeviceInfo.local_ip}:8000`;
            console.log('ğŸŒ ìƒˆ IP ì£¼ì†Œë¡œ baseURL ì—…ë°ì´íŠ¸:', newBaseUrl);
  
            await saveDeviceURL(newBaseUrl);
  
            if (Platform.OS === 'web' && typeof window !== 'undefined') {
              localStorage.setItem('deviceInfo', JSON.stringify(newDeviceInfo));
              console.log('ğŸ’¾ ì›¹ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì—…ë°ì´íŠ¸ëœ ê¸°ê¸° ì •ë³´ ì €ì¥ë¨');
            } else {
              await storeData('deviceInfo', newDeviceInfo);
            }
  
            if (connectDevice) {
              await connectDevice(newDeviceInfo);
            }
  
            console.log('ğŸ”„ ê¸°ê¸° ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            try {
              await refreshDeviceStatus();
              console.log('âœ… ê¸°ê¸° ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì„±ê³µ');
            } catch (refreshError) {
              console.error('âš ï¸ ê¸°ê¸° ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨, í•˜ì§€ë§Œ ê³„ì† ì§„í–‰:', refreshError);
            }
  
            if (Platform.OS === 'web') {
              window.alert('WiFi ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©° ê¸°ê¸°ê°€ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
              try {
                navigation.navigate('Main');
              } catch (navError) {
                console.error('âš ï¸ ë„¤ë¹„ê²Œì´ì…˜ ì˜¤ë¥˜, í™ˆìœ¼ë¡œ ì§ì ‘ ì´ë™:', navError);
                window.location.href = '/';
              }
            } else {
              Alert.alert(
                'ì—°ê²° ì„±ê³µ',
                'WiFi ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©° ê¸°ê¸°ê°€ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.',
                [{
                  text: 'í™•ì¸',
                  onPress: () => {
                    console.log('ğŸ  í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™ ì‹œë„');
                    try {
                      navigation.navigate('Main');
                    } catch (navError) {
                      console.error('âš ï¸ ë„¤ë¹„ê²Œì´ì…˜ ì˜¤ë¥˜:', navError);
                      navigation.goBack();
                    }
                  }
                }]
              );
            }
          } else {
            throw new Error('ìƒˆ IP ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          console.error('âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
  
          if (Platform.OS === 'web') {
            window.alert(`WiFi ì„¤ì •ì€ ì ìš©ë˜ì—ˆì§€ë§Œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            window.location.href = '/';
          } else {
            Alert.alert(
              'ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨',
              'WiFi ì„¤ì •ì€ ì ìš©ë˜ì—ˆì§€ë§Œ, ê¸°ê¸° ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
              [{
                text: 'í™•ì¸',
                onPress: () => {
                  console.log('ğŸ  í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™ (í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨)');
                  navigation.reset({
                    index: 0,
                    routes: [{ name: 'HomeTab' }]
                  });
                }
              }]
            );
          }
        }
      } else {
        console.log('âŒ WiFi ì„¤ì • ì‹¤íŒ¨');
        Alert.alert(
          'ì„¤ì • ì‹¤íŒ¨',
          response.data?.message || 'WiFi ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
        );
      }
    } catch (error) {
      console.error('âŒ WiFi ì„¤ì • ì˜¤ë¥˜:', error);
      Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsSubmitting(false);
      setIsTestingConnection(false);
    }
  };  
  
  
  const handleSkip = () => {
    console.log('ğŸ”˜ ê±´ë„ˆë›°ê¸° ë²„íŠ¼ í´ë¦­ë¨');
    Alert.alert(
      'WiFi ì„¤ì • ê±´ë„ˆë›°ê¸°',
      'WiFi ì„¤ì •ì„ ê±´ë„ˆë›°ë©´ ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      [
        { text: 'ì·¨ì†Œ', style: 'cancel' },
        { 
          text: 'ê³„ì†', 
          onPress: () => {
            console.log('ğŸ  í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™ (ê±´ë„ˆë›°ê¸°)');
            navigation.reset({
              index: 0,
              routes: [{ name: 'HomeTab' }]
            });
          }
        }
      ]
    );
  };
  
  // í™ˆìœ¼ë¡œ ê°•ì œ ì´ë™ í•¸ë“¤ëŸ¬
  const forceNavigateToHome = () => {
    console.log('ğŸ”˜ ê°•ì œ ì´ë™ ë²„íŠ¼ í´ë¦­ë¨');
    navigation.reset({
      index: 0,
      routes: [{ name: 'HomeTab' }]
    });
  };
  
  if (loading) {
    console.log('ğŸ”„ ë¡œë”© ìƒíƒœë¡œ ë Œë”ë§');
    return <LoadingSpinner message="WiFi ì„¤ì • ì¤€ë¹„ ì¤‘..." />;
  }
  
  console.log('ğŸ“„ WifiSetupScreen ë Œë”ë§');
  
  // ë””ë°”ì´ìŠ¤ ì •ë³´ ê²°ì • (ì»¨í…ìŠ¤íŠ¸ ë˜ëŠ” ë¡œì»¬)
  const displayDeviceInfo = deviceInfo || localDeviceInfo;
  
  // WiFi ë„¤íŠ¸ì›Œí¬ ëª©ë¡ ë Œë”ë§ - í•œê¸€ ì²˜ë¦¬ ê°œì„ 
  const renderNetworkList = () => {
    console.log('ğŸ’­ ëª©ë¡ì— í‘œì‹œë  ë„¤íŠ¸ì›Œí¬:', networks.length, 'ê°œ');
    
    // ë””ë²„ê¹…ìš©: ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì¶œë ¥
    networks.forEach((network, idx) => {
      console.log(`ë„¤íŠ¸ì›Œí¬ ${idx+1}:`, {
        ssid: network.ssid,
        ssid_raw: network.ssid_raw,
        security: network.security,
        connected: network.connected
      });
    });
    
    if (networks.length === 0 && !isScanning) {
      return (
        <View style={styles.emptyNetworkContainer}>
          <Text style={styles.emptyNetworkText}>ë°œê²¬ëœ WiFi ë„¤íŠ¸ì›Œí¬ê°€ ì—†ìŠµë‹ˆë‹¤</Text>
          <TouchableOpacity 
            style={styles.refreshButton}
            onPress={scanWifiNetworks}
            activeOpacity={0.7}
          >
            <Text style={styles.refreshButtonText}>ë‹¤ì‹œ ìŠ¤ìº”í•˜ê¸°</Text>
          </TouchableOpacity>
        </View>
      );
    }
    
    return (
      <View style={styles.networkListContainer}>
        {isScanning && (
          <View style={styles.scanningIndicator}>
            <ActivityIndicator size="small" color={Colors.primary} />
            <Text style={styles.scanningText}>WiFi ë„¤íŠ¸ì›Œí¬ ìŠ¤ìº” ì¤‘...</Text>
          </View>
        )}
        
        {networks.map((network, index) => {
          // í•œê¸€ SSID ì²˜ë¦¬
          let displayName = network.ssid;
          try {
            // 1. URL ì¸ì½”ë”©ì´ ëœ ê²½ìš° ë””ì½”ë”© ì‹œë„
            if (network.ssid && network.ssid.includes('%')) {
              displayName = decodeURIComponent(network.ssid);
            }
            
            // 2. í™•ì¸í•œ ì›ë³¸ ë°ì´í„°ì—ì„œ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ì²˜ë¦¬
            if (network.ssid_raw && network.ssid_raw.includes('\\x')) {
              displayName = decodeHexEscapeSequence(network.ssid_raw);
              console.log(`ë„¤íŠ¸ì›Œí¬ ${index+1} í•œê¸€ ì´ë¦„ ë³µì›:`, displayName);
            }
            // ë””ì½”ë”©ëœ ê°’ì—ë„ ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ê°€ ìˆëŠ” ê²½ìš°
            else if (displayName && displayName.includes('\\x')) {
              displayName = decodeHexEscapeSequence(displayName);
            }
          } catch (e) {
            console.warn(`ë„¤íŠ¸ì›Œí¬ ${index+1} ë””ì½”ë”© ì˜¤ë¥˜:`, e);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
            displayName = network.ssid || 'ìˆ¨ê²¨ì§„ ë„¤íŠ¸ì›Œí¬';
          }
          
          return (
            <TouchableOpacity
              key={`${network.ssid}-${index}`}
              style={styles.networkItem}
              onPress={() => handleSelectNetwork(network)}
              activeOpacity={0.7}
            >
              <View style={styles.networkIconContainer}>
                <Ionicons 
                  name={getSignalIcon(network.signal_strength)} 
                  size={24} 
                  color={Colors.primary} 
                />
              </View>
              <View style={styles.networkInfo}>
                <Text style={styles.networkName}>{displayName || 'ìˆ¨ê²¨ì§„ ë„¤íŠ¸ì›Œí¬'}</Text>
                <View style={styles.networkDetails}>
                  <Ionicons 
                    name={getSecurityIcon(network.security)} 
                    size={16} 
                    color={Colors.darkGray} 
                    style={styles.securityIcon}
                  />
                  <Text style={styles.networkSecurity}>{network.security}</Text>
                </View>
              </View>
              <Ionicons name="chevron-forward" size={20} color={Colors.lightGray} />
            </TouchableOpacity>
          );
        })}
      </View>
    );
  };
  
  return (
    <KeyboardAvoidingView 
      style={styles.container} 
      behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      keyboardVerticalOffset={Platform.OS === 'ios' ? 64 : 0}
    >
      <Header title="WiFi ì„¤ì •" showBackButton />
      <ScrollView 
        contentContainerStyle={styles.scrollContainer}
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={handleRefresh}
            colors={[Colors.primary]}
            tintColor={Colors.primary}
          />
        }
      >
        <View style={styles.content}>
          <Text style={styles.title}>WiFi ì„¤ì •</Text>
          {displayDeviceInfo && (
            <View style={styles.deviceInfoContainer}>
              <Text style={styles.deviceInfoTitle}>ì—°ê²°ëœ ê¸°ê¸°</Text>
              <Text style={styles.deviceInfo}>
                ID: {displayDeviceInfo.device_id}
              </Text>
              <Text style={styles.deviceInfo}>
                IP: {displayDeviceInfo.local_ip}
              </Text>
            </View>
          )}
          
          <Text style={styles.instructions}>
            EasyCloud ê¸°ê¸°ê°€ ì¸í„°ë„·ì— ì—°ê²°í•  ìˆ˜ ìˆë„ë¡ WiFi ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
          </Text>
          
          {/* WiFi ëª©ë¡ í‘œì‹œ ì˜ì—­ */}
          <View style={styles.wifiListContainer}>
            <View style={styles.wifiListHeader}>
              <Text style={styles.wifiListTitle}>ì£¼ë³€ WiFi ë„¤íŠ¸ì›Œí¬</Text>
              <TouchableOpacity 
                onPress={scanWifiNetworks}
                disabled={isScanning}
                activeOpacity={0.7}
                style={styles.scanButton}
              >
                <Ionicons 
                  name="refresh" 
                  size={20} 
                  color={isScanning ? Colors.lightGray : Colors.primary} 
                />
              </TouchableOpacity>
            </View>
            
            {renderNetworkList()}
          </View>
          
          <View style={styles.form}>
            <Text style={styles.sectionTitle}>ìˆ˜ë™ ì—°ê²°</Text>
            <Input
              label="WiFi ì´ë¦„ (SSID)"
              value={ssid}
              onChangeText={setSsid}
              placeholder="WiFi ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
              error={errors.ssid}
              disabled={isSubmitting || isTestingConnection}
            />
            
            <Input
              label="ë¹„ë°€ë²ˆí˜¸"
              value={password}
              onChangeText={setPassword}
              placeholder="WiFi ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì—†ìœ¼ë©´ ë¹ˆì¹¸)"
              secureTextEntry
              error={errors.password}
              disabled={isSubmitting || isTestingConnection}
            />
            
            {/* ìˆ˜ì •ëœ ë²„íŠ¼ - disabled ì†ì„± ì œê±°í•˜ê³  onPress ì¡°ê±´ë¶€ ì²˜ë¦¬ */}
            <TouchableOpacity 
              style={[
                styles.button, 
                styles.primaryButton,
                (isSubmitting || isTestingConnection) && styles.disabledButton
              ]}
              onPress={isSubmitting || isTestingConnection ? undefined : handleSetupWifi}
              activeOpacity={0.7}
            >
              <Text style={styles.buttonText}>
                {isSubmitting ? 'ì„¤ì • ì¤‘...' : 'WiFi ì„¤ì •í•˜ê¸°'}
              </Text>
              {isSubmitting && (
                <ActivityIndicator 
                  size="small" 
                  color="#fff" 
                  style={styles.buttonLoader} 
                />
              )}
            </TouchableOpacity>
            
            {/* ìˆ˜ì •ëœ ë‚˜ì¤‘ì— ì„¤ì •í•˜ê¸° ë²„íŠ¼ - disabled ì†ì„± ì œê±° */}
            <TouchableOpacity 
              style={[
                styles.button, 
                styles.outlineButton,
                (isSubmitting || isTestingConnection) && styles.disabledButton
              ]}
              onPress={isSubmitting || isTestingConnection ? undefined : handleSkip}
              activeOpacity={0.7}
            >
              <Text style={styles.outlineButtonText}>ë‚˜ì¤‘ì— ì„¤ì •í•˜ê¸°</Text>
            </TouchableOpacity>
            
            {/* í™ˆìœ¼ë¡œ ê°•ì œ ì´ë™ ë²„íŠ¼ */}
            <TouchableOpacity 
              style={[styles.button, styles.secondaryButton]}
              onPress={forceNavigateToHome}
              activeOpacity={0.7}
            >
              <Text style={styles.buttonText}>í™ˆìœ¼ë¡œ ê°•ì œ ì´ë™ (ë””ë²„ê¹…ìš©)</Text>
            </TouchableOpacity>
          </View>
          
          {/* ì›¹ í™˜ê²½ì—ì„œ ì¼ë°˜ HTML ë²„íŠ¼ í…ŒìŠ¤íŠ¸ */}
          {Platform.OS === 'web' && (
            <div style={{ marginTop: 20 }}>
              <button 
                onClick={forceNavigateToHome}
                style={{ 
                  padding: 10, 
                  backgroundColor: 'red', 
                  color: 'white', 
                  border: 'none',
                  borderRadius: 5,
                  cursor: 'pointer',
                  width: '100%',
                  fontSize: 16
                }}
              >
                HTML í™ˆìœ¼ë¡œ ê°•ì œ ì´ë™
              </button>
            </div>
          )}
          
          {isTestingConnection && (
            <View style={styles.testingContainer}>
              <ActivityIndicator color={Colors.primary} size="large" />
              <Text style={styles.testingText}>
                ê¸°ê¸°ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘...
              </Text>
              <Text style={styles.testingSubtext}>
                ì´ ê³¼ì •ì€ ìµœëŒ€ 30ì´ˆê°€ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </Text>
            </View>
          )}
          
          <Text style={styles.note}>
            ì°¸ê³ : WiFi ì„¤ì • í›„ ê¸°ê¸°ê°€ ìƒˆ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </Text>
        </View>
      </ScrollView>
    </KeyboardAvoidingView>
  );
};
  
const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.background,
    zIndex: 999, // ìµœìƒìœ„ ë ˆì´ì–´ë¡œ ì„¤ì •
  },
  scrollContainer: {
    flexGrow: 1,
  },
  content: {
    flex: 1,
    padding: 24,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    color: Colors.primary,
    marginBottom: 16,
  },
  deviceInfoContainer: {
    backgroundColor: Colors.card,
    borderRadius: 12,
    padding: 16,
    marginBottom: 24,
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
      },
      android: {
        elevation: 4,
      },
      web: {
        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
      },
    }),
  },
  deviceInfoTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    marginBottom: 8,
    color: Colors.primary,
  },
  deviceInfo: {
    fontSize: 14,
    color: Colors.text,
    marginBottom: 4,
  },
  instructions: {
    fontSize: 16,
    color: Colors.text,
    marginBottom: 16,
    lineHeight: 24,
  },
  
  // WiFi ëª©ë¡ ê´€ë ¨ ìŠ¤íƒ€ì¼
  wifiListContainer: {
    backgroundColor: Colors.card,
    borderRadius: 12,
    marginBottom: 24,
    overflow: 'hidden',
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
      },
      android: {
        elevation: 4,
      },
      web: {
        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
      },
    }),
  },
  wifiListHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  wifiListTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: Colors.text,
  },
  scanButton: {
    padding: 8,
  },
  networkListContainer: {
    maxHeight: 300,
    ...(Platform.OS === 'web' ? {
      overflowY: 'auto',
      WebkitOverflowScrolling: 'touch'
    } : {})
  },
  scanningIndicator: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 12,
    backgroundColor: Colors.lightBackground,
  },
  scanningText: {
    marginLeft: 8,
    color: Colors.text,
    fontSize: 14,
  },
  networkItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  networkIconContainer: {
    marginRight: 12,
  },
  networkInfo: {
    flex: 1,
  },
  networkName: {
    fontSize: 16,
    fontWeight: '500',
    color: Colors.text,
    marginBottom: 4,
  },
  networkDetails: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  securityIcon: {
    marginRight: 4,
  },
  networkSecurity: {
    fontSize: 12,
    color: Colors.darkGray,
  },
  emptyNetworkContainer: {
    padding: 24,
    alignItems: 'center',
    justifyContent: 'center',
  },
  emptyNetworkText: {
    fontSize: 14,
    color: Colors.darkGray,
    marginBottom: 16,
    textAlign: 'center',
  },
  refreshButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    backgroundColor: Colors.primary,
    borderRadius: 8,
  },
  refreshButtonText: {
    color: '#fff',
    fontSize: 14,
    fontWeight: '600',
  },
  
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: Colors.text,
    marginBottom: 16,
    marginTop: 8,
  },
  form: {
    marginBottom: 24,
  },
  // ì§ì ‘ êµ¬í˜„í•œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
  button: {
    borderRadius: 8,
    paddingVertical: 12,
    paddingHorizontal: 20,
    marginVertical: 8,
    flexDirection: 'row',
    justifyContent: 'center',
    alignItems: 'center',
  },
  primaryButton: {
    backgroundColor: Colors.primary,
  },
  secondaryButton: {
    backgroundColor: Colors.secondary || '#666',
  },
  testButton: {
    backgroundColor: 'green',
  },
  outlineButton: {
    backgroundColor: 'transparent',
    borderWidth: 1,
    borderColor: Colors.primary,
  },
  disabledButton: {
    opacity: 0.6,
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
    textAlign: 'center',
  },
  outlineButtonText: {
    color: Colors.primary,
    fontSize: 16,
    fontWeight: '600',
    textAlign: 'center',
  },
  buttonLoader: {
    marginLeft: 8,
  },
  testingContainer: {
    backgroundColor: Colors.lightGray,
    borderRadius: 12,
    padding: 20,
    alignItems: 'center',
    marginBottom: 24,
  },
  testingText: {
    fontSize: 16,
    color: Colors.text,
    marginTop: 16,
    textAlign: 'center',
  },
  testingSubtext: {
    fontSize: 14,
    color: Colors.darkGray,
    marginTop: 8,
    textAlign: 'center',
  },
  note: {
    fontSize: 14,
    color: Colors.darkGray,
    fontStyle: 'italic',
  },
});
  
export default WifiSetupScreen;